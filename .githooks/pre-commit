#!/usr/bin/env bash

set -e

# Ensure we are in the nix develop shell or direnv environment
if [[ -z "${IN_NIX_SHELL:-}" ]] && [[ -z "${DIRENV_DIR:-}" ]]; then
  SCRIPT_REENTRY_GUARD="__SCRIPT_$(basename "$0" | tr '-' '_')_ENTERED"
  if [[ -n "${!SCRIPT_REENTRY_GUARD:-}" ]]; then
    echo "Error: IN_NIX_SHELL and DIRENV_DIR are not set even after entering nix develop." >&2
    echo "Please check your flake.nix devShell configuration or use direnv." >&2
    exit 1
  fi
  export "$SCRIPT_REENTRY_GUARD"=1
  exec nix develop --command "$0" "$@"
fi

echo "Running pre-commit hook..."

pnpm run format:check

staged_files=$(git diff --cached --name-only --diff-filter=ACM)
if [ -z "$staged_files" ]; then
  exit 0
fi

PATTERN_BLOG='^content/blog/'
PATTERN_HOOKS='^.githooks/'

blog_changes=$(echo "$staged_files" | grep "$PATTERN_BLOG" || [ $? -eq 1 ])
if [ -n "$blog_changes" ]; then
  pnpm run textlint
fi

hooks_changes=$(echo "$staged_files" | grep "$PATTERN_HOOKS" || [ $? -eq 1 ])
if [ -n "$hooks_changes" ]; then
  echo -e "\n> shellcheck .githooks/*"
  shellcheck .githooks/*
fi

code_changes=$(echo "$staged_files" | grep -v "$PATTERN_BLOG" | grep -v "$PATTERN_HOOKS" || [ $? -eq 1 ])
if [ -n "$code_changes" ]; then
  pnpm run typecheck
  pnpm run check
fi

echo ''
exit 0
