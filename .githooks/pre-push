#!/usr/bin/env bash

set -e

# Ensure we are in the nix develop shell or direnv environment
if [[ -z "${IN_NIX_SHELL:-}" ]] && [[ -z "${DIRENV_DIR:-}" ]]; then
  SCRIPT_REENTRY_GUARD="__SCRIPT_$(basename "$0" | tr '-' '_')_ENTERED"
  if [[ -n "${!SCRIPT_REENTRY_GUARD:-}" ]]; then
    echo "Error: IN_NIX_SHELL and DIRENV_DIR are not set even after entering nix develop." >&2
    echo "Please check your flake.nix devShell configuration or use direnv." >&2
    exit 1
  fi
  export "$SCRIPT_REENTRY_GUARD"=1
  exec nix develop --command "$0" "$@"
fi

echo "Running pre-push hook..."

push_info=$(cat)

pnpm run format:check

PATTERN_BLOG='^content/blog/'
PATTERN_HOOKS='^.githooks/'

echo "$push_info" | while read -r _local_ref local_oid _remote_ref remote_oid; do
  if [ "$remote_oid" = "0000000000000000000000000000000000000000" ]; then
    range="$local_oid"
  else
    range="$remote_oid..$local_oid"
  fi

  changed_files=$(git diff --name-only "$range" 2>/dev/null)
  if [ -z "$changed_files" ]; then
    continue
  fi

  blog_changes=$(echo "$changed_files" | grep "$PATTERN_BLOG" || [ $? -eq 1 ])
  if [ -n "$blog_changes" ]; then
    pnpm run textlint
  fi

  hooks_changes=$(echo "$changed_files" | grep "$PATTERN_HOOKS" || [ $? -eq 1 ])
  if [ -n "$hooks_changes" ]; then
    echo -e "\n> shellcheck .githooks/*"
    shellcheck .githooks/*
  fi

  code_changes=$(echo "$changed_files" | grep -v "$PATTERN_BLOG" | grep -v "$PATTERN_HOOKS" || [ $? -eq 1 ])
  if [ -n "$code_changes" ]; then
    pnpm run typecheck
    pnpm run check
  fi
done

echo ''
exit 0
